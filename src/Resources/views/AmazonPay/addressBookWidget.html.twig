<script type='text/javascript'>
    var amazonOrderReferenceId = null;

    window.onAmazonLoginReady = function () {
        try {
            amazon.Login.setClientId('{{ amazon.clientId }}');
            amazon.Login.setUseCookie(true);
        } catch (err) {
            alert(err);
        }
    };

    window.onAmazonPaymentsReady = function () {
        new OffAmazonPayments.Widgets.AddressBook({
            sellerId: "{{ amazon.merchantId }}",
            onOrderReferenceCreate: function (orderReference) {
                amazonOrderReferenceId = orderReference.getAmazonOrderReferenceId();
                $.post('{{ path('tierperso_sylius_amazon_pay_plugin_get_order_details') }}', {
                    orderReferenceId: amazonOrderReferenceId,
                    accessToken: accessToken
                }).done(function (data) {
                    try {
                        JSON.parse(data);
                    } catch (err) {
                    }
                });
            },
            onAddressSelect: function (orderReference) {
                $.post('{{ path('tierperso_sylius_amazon_pay_plugin_get_order_details') }}', {
                    orderReferenceId: amazonOrderReferenceId,
                    accessToken: accessToken
                }).done(function (data) {
                    try {
                        JSON.parse(data);
                    } catch (err) {
                    }
                    var addressData = data.GetOrderReferenceDetailsResult.OrderReferenceDetails;
                    $('#sylius_checkout_address_customer_email').val(addressData.Buyer.Email);
                    $('#sylius_checkout_address_shippingAddress_company').val(addressData.Buyer.Name);
                    $('#sylius_checkout_address_shippingAddress_street').val(addressData.Destination.PhysicalDestination.AddressLine1);
                    $('#sylius_checkout_address_shippingAddress_provinceName').val(addressData.Destination.PhysicalDestination.StateOrRegion);
                    $('#sylius_checkout_address_shippingAddress_city').val(addressData.Destination.PhysicalDestination.City);
                    $('#sylius_checkout_address_shippingAddress_postcode').val(addressData.Destination.PhysicalDestination.PostalCode);
                    $('#sylius_checkout_address_shippingAddress_phoneNumber').val(addressData.Destination.PhysicalDestination.Phone);
                });
            },
            design: {
                designMode: 'responsive'
            },
            onError: function (error) {
                alert("AddressBook Widget error: " + error.getErrorCode() + ' - ' + error.getErrorMessage());
            }
        }).bind("addressBookWidgetDiv");
        };

</script>

<script async="async" type='text/javascript' src='https://static-eu.payments-amazon.com/OffAmazonPayments{{ amazon.amazonApiRegion }}{{ amazon.amazonApiEnvironment }}/lpa/js/Widgets.js'></script>

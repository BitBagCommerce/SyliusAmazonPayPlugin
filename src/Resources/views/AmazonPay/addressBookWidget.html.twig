<script type='text/javascript'>
    function getURLParameter(name, source) {
        return decodeURIComponent((new RegExp('[?|&|#]' + name + '=' +
            '([^&]+?)(&|#|;|$)').exec(source) || [,""])[1].replace(/\+/g,
            '%20')) || null;
    }
    var accessToken = getURLParameter("access_token", location.hash);

    var amazonOrderReferenceId = null;

    window.onAmazonLoginReady = function () {
        try {
            amazon.Login.setClientId('{{ amazon.clientId }}');
            amazon.Login.setUseCookie(true);
        } catch (err) {
            alert(err);
        }
    };

    window.onAmazonPaymentsReady = function () {
        new OffAmazonPayments.Widgets.AddressBook({
            sellerId: "{{ amazon.merchantId }}",
            onOrderReferenceCreate: function (orderReference) {
                amazonOrderReferenceId = orderReference.getAmazonOrderReferenceId();
                $.post('{{ path('tierperso_sylius_amazon_pay_plugin_get_order_details') }}', {
                    orderReferenceId: amazonOrderReferenceId,
                    accessToken: accessToken
                }).done(function (data) {
                    try {
                        JSON.parse(data);
                    } catch (err) {
                    }
                    console.log(data);
                });

            },
            onAddressSelect: function (orderReference) {
                $.post('{{ path('tierperso_sylius_amazon_pay_plugin_get_order_details') }}', {
                    orderReferenceId: amazonOrderReferenceId,
                    accessToken: accessToken
                }).done(function (data) {
                    try {
                        JSON.parse(data);
                    } catch (err) {
                    }
                    var name = data.GetOrderReferenceDetailsResult.OrderReferenceDetails.Destination.PhysicalDestination.Name;
                    var splitName = name.split(" ");
                    console.log(data);
                    $('#sylius_checkout_address_customer_email').val(data.GetOrderReferenceDetailsResult.OrderReferenceDetails.Buyer.Email);
                    $('#sylius_checkout_address_shippingAddress_firstName').val(splitName[0]);
                    $('#sylius_checkout_address_shippingAddress_lastName').val(splitName[1]);
                    $('#sylius_checkout_address_shippingAddress_company').val(data.GetOrderReferenceDetailsResult.OrderReferenceDetails.Buyer.Name);
                    $('#sylius_checkout_address_shippingAddress_street').val(data.GetOrderReferenceDetailsResult.OrderReferenceDetails.Destination.PhysicalDestination.AddressLine1);
                    $('#sylius_checkout_address_shippingAddress_provinceName').val(data.GetOrderReferenceDetailsResult.OrderReferenceDetails.Destination.PhysicalDestination.StateOrRegion);
                    $('#sylius_checkout_address_shippingAddress_city').val(data.GetOrderReferenceDetailsResult.OrderReferenceDetails.Destination.PhysicalDestination.City);
                    $('#sylius_checkout_address_shippingAddress_postcode').val(data.GetOrderReferenceDetailsResult.OrderReferenceDetails.Destination.PhysicalDestination.PostalCode);
                    $('#sylius_checkout_address_shippingAddress_phoneNumber').val(data.GetOrderReferenceDetailsResult.OrderReferenceDetails.Destination.PhysicalDestination.Phone);

                    console.log(data);
                });
            },
            design: {
                designMode: 'responsive'
            },
            onError: function (error) {
                alert("AddressBook Widget error: " + error.getErrorCode() + ' - ' + error.getErrorMessage());
            }
        }).bind("addressBookWidgetDiv");
        };

</script>

<script async="async" type='text/javascript' src='https://static-eu.payments-amazon.com/OffAmazonPayments{{ amazon.amazonApiRegion }}{{ amazon.amazonApiEnvironment }}/lpa/js/Widgets.js'></script>
